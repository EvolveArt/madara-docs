# 在 Madara 中进行协议变更

Madara 自下向上开发，旨在促进模块化和可配置性，允许开发者根据其特定产品需求修改应用链配置。
这包括允许对关键 Starknet 参数进行细粒度控制。

我们将深入研究位于 `~/crates/runtime/src/pallets.rs` 的 Starknet 模块。

| 参数             | 说明                                                                                            | 默认            |
| --------------------- | --------------------------------------------------------------------------------------------------------- | ------------------ |
| InvokeTxMaxNSteps     | 单个交易中允许的最大 Cairo 步数                                                   | 1,000,000          |
| ValidateMaxNSteps     | 在一个 `__validate__` 操作中允许的最大 Cairo 步数                                             | 1,000,000          |
| MaxRecursionDepth     | 允许的最大递归深度。                                                                          | 50                 |
| ProgramHash           | 验证 Starknet OS 哈希                                                                                 | SN_OS_PROGRAM_HASH |
| DisableTransactionFee | 禁用交易费用的标志，也可以通过使用 Rust 功能标志 `disable-transaction-fee` 来设置。              |

这些参数可以在 [Starknet Pallet 文件](https://github.com/keep-starknet-strange/madara/blob/main/crates/runtime/src/pallets.rs)中的 `parameter_types` 宏进行配置。

### 配置 InvokeTxMaxNSteps

Starknet 的 `invoke` 功能允许用户在单个交易中执行一系列函数调用。对 invoke 交易强制执行最大步骤限制提供了几个好处：

- 可预测的费用：设置限制可以防止用户因不受限制的执行步骤而意外创建开销巨大的交易，从而便于交易费用的可预测性和可管理性。
- 公平性和稳定性：限制步数促进了用户之间公平的资源共享，防止任何单一交易消耗过多资源并影响网络稳定性。
- 遵守区块时间：最大步骤限制还有助于确保交易符合指定的区块时间，有助于网络的整体可预测性和稳定性。

本质上，`InvokeTxMaxNSteps` 在允许应用链开发者配置他们的 Dapp 以确保安全性和性能方面发挥着关键作用。

### 配置 ValidateMaxNSteps

Starknet 的 `__validate__` 函数充当预执行检查。该函数接收用户的调用并执行验证，以验证是否遵守合约的约束条件。其返回 `VALID` 表示成功验证，否则中止交易，并防止未授权或无效的操作。

`ValidateMaxNSteps` 在 `__validate__` 函数中强制执行最大步骤限制，以防范 DoS 攻击。
由于失败的 `__validate__` 调用不会产生费用，恶意行为者可能利用它们用无效交易来过载网络。尽管链可以通过 KYC、中心化检查等其他方法，来防止 DoS 并允许在验证期间进行更大的步骤，但限制 **validate** 函数的复杂性在缓解链上 DoS 威胁方面仍然至关重要。

### 配置 MaxRecursionDepth

`MaxRecursionDepth` 作为防范 Cairo 合约中无限循环的关键保障机制，定义了函数在执行被终止之前可以递归调用自身的最大次数。

此参数对以下方面至关重要：

- 防止 DoS 攻击：恶意行为者可以利用不受限制的递归创建无限循环，消耗过多资源并可能使网络操作停滞。
- 鼓励高效编码：通过对递归施加限制，激励开发者编写使用迭代方法或替代控制流机制的代码。

总体而言，`MaxRecursionDepth` 在防止无限循环和鼓励合约中健全的编程实践方面发挥了至关重要的作用，从而维护了 Starknet 网络的安全性、稳定性和效率。

### 配置 ProgramHash

`ProgramHash` 字段是特定 Starknet 操作系统版本的加密标识符，用于生成 L1 验证证明。这些证明提交到基础层进行验证。

此字段必须与 Madara 支持的最新哈希匹配，以保证证明生成的一致性，确保当 Starknet 操作系统进行升级时，应用链相应地得到更新。这确保所有新生成的证明都使用最新版本，使网络能够在保持与现有基础设施兼容的同时安全地发展。

### 配置 DisableTransactionFee

`DisableTransactionFee` 是一个可配置参数，允许开发者在设计他们的应用链经济模型时具有灵活性。启用后，此标志为与应用链交互的用户免除交易费用。这就带来：

- 无摩擦的入门体验：取消费用可以简化用户采纳过程，尤其是对于那些对用户来说交易应该抽象出来的 Dapp 而言。
- 替代收入模型：开发者可以探索通过赞助、订阅或应用内互动等方式进行货币化，而不是仅仅依赖基于交易的费用。
- 实验性用例：`DisableTransactionFee` 便于在受控环境中测试新颖的经济概念或费用结构。

> **_注意：_**虽然交易费可能会阻碍某些用户，但作为防止垃圾交易和 DoS 攻击的重要经济屏障，禁用之前需要考虑清楚。
